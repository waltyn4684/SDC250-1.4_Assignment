/* ============================================================
   ManipulateDBStructure.sql  (Re-runnable)
   - Safe re-run (drops/recreates tables and views)
   - Only migrates from STOREFRONT if it exists
   ============================================================ */

SET DEFINE OFF;

/* ------------------------------------------------------------
   QUESTION 1: Alter PRODUCTLIST, migrate from STOREFRONT (if exists),
               then drop STOREFRONT (if exists)
   ------------------------------------------------------------ */

-- Add PRICE column if it doesn't already exist
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE PRODUCTLIST ADD (PRICE NUMBER(8,2))';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -1430 THEN RAISE; END IF;  -- ORA-01430: column being added already exists
END;
/

-- Add DESCRIPTION column if it doesn't already exist
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE PRODUCTLIST ADD (DESCRIPTION VARCHAR2(250))';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -1430 THEN RAISE; END IF;
END;
/

-- Migrate PRICE/DESCRIPTION from STOREFRONT into PRODUCTLIST
-- Only runs if STOREFRONT exists (prevents ORA-00942)
DECLARE
  v_cnt NUMBER;
BEGIN
  SELECT COUNT(*)
  INTO v_cnt
  FROM user_tables
  WHERE table_name = 'STOREFRONT';

  IF v_cnt > 0 THEN
    EXECUTE IMMEDIATE q'[
      UPDATE PRODUCTLIST P
      SET (PRICE, DESCRIPTION) =
      (
        SELECT S.PRICE, S.DESCRIPTION
        FROM STOREFRONT S
        WHERE S.PRODUCTCODE = P.PRODUCTCODE
      )
      WHERE EXISTS (
        SELECT 1
        FROM STOREFRONT S
        WHERE S.PRODUCTCODE = P.PRODUCTCODE
      )
    ]';
  END IF;
END;
/

-- Drop STOREFRONT if it exists (ignore ORA-00942)
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE STOREFRONT CASCADE CONSTRAINTS PURGE';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;  -- ORA-00942: table or view does not exist
END;
/

/* ------------------------------------------------------------
   DROP OBJECTS (so re-run works cleanly)
   Drop children before parents
   ------------------------------------------------------------ */

-- Drop VIEWS (ignore ORA-00942)
BEGIN EXECUTE IMMEDIATE 'DROP VIEW ACTIVE_TICKETS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP VIEW UNIQUE_SECURITY_QUESTIONS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/

-- Drop TABLES (ignore ORA-00942)
BEGIN EXECUTE IMMEDIATE 'DROP TABLE INFRACTIONS CASCADE CONSTRAINTS PURGE';     EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE WISHLIST CASCADE CONSTRAINTS PURGE';        EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE FRIENDSLIST CASCADE CONSTRAINTS PURGE';     EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE CHATLOG CASCADE CONSTRAINTS PURGE';         EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE SECURITYQUESTION CASCADE CONSTRAINTS PURGE';EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE USERPROFILE CASCADE CONSTRAINTS PURGE';     EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE USERSUPPORT CASCADE CONSTRAINTS PURGE';     EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE COMMUNITYRULES CASCADE CONSTRAINTS PURGE';  EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/

/* ------------------------------------------------------------
   QUESTION 2: Create CHATLOG + insert 10 records
   ------------------------------------------------------------ */

CREATE TABLE CHATLOG (
  CHATID     NUMBER(3) PRIMARY KEY,
  RECEIVERID NUMBER(3),
  SENDERID   NUMBER(3),
  DATESENT   DATE,
  CONTENT    VARCHAR2(250),
  CONSTRAINT FK_CHAT_RECEIVER FOREIGN KEY (RECEIVERID) REFERENCES USERBASE(USERID),
  CONSTRAINT FK_CHAT_SENDER   FOREIGN KEY (SENDERID)   REFERENCES USERBASE(USERID)
);

INSERT INTO CHATLOG VALUES (1,101,102,SYSDATE,'Hey, want to play tonight?');
INSERT INTO CHATLOG VALUES (2,102,101,SYSDATE,'Sure, sounds good!');
INSERT INTO CHATLOG VALUES (3,103,101,SYSDATE,'Good match earlier.');
INSERT INTO CHATLOG VALUES (4,104,105,SYSDATE,'Need help leveling up.');
INSERT INTO CHATLOG VALUES (5,105,104,SYSDATE,'I got you.');
INSERT INTO CHATLOG VALUES (6,101,103,SYSDATE,'Letâ€™s team up.');
INSERT INTO CHATLOG VALUES (7,102,104,SYSDATE,'Invite sent.');
INSERT INTO CHATLOG VALUES (8,105,102,SYSDATE,'Accepted.');
INSERT INTO CHATLOG VALUES (9,103,105,SYSDATE,'Nice strategy.');
INSERT INTO CHATLOG VALUES (10,104,101,SYSDATE,'Good game!');

/* ------------------------------------------------------------
   QUESTION 3: Create FRIENDSLIST + insert 10 records
   ------------------------------------------------------------ */

CREATE TABLE FRIENDSLIST (
  USERID   NUMBER(3),
  FRIENDID NUMBER(3),
  CONSTRAINT PK_FRIENDSLIST PRIMARY KEY (USERID, FRIENDID),
  CONSTRAINT FK_FRIEND_USER   FOREIGN KEY (USERID)   REFERENCES USERBASE(USERID),
  CONSTRAINT FK_FRIEND_FRIEND FOREIGN KEY (FRIENDID) REFERENCES USERBASE(USERID)
);

INSERT INTO FRIENDSLIST VALUES (101,102);
INSERT INTO FRIENDSLIST VALUES (101,103);
INSERT INTO FRIENDSLIST VALUES (102,104);
INSERT INTO FRIENDSLIST VALUES (103,105);
INSERT INTO FRIENDSLIST VALUES (104,101);
INSERT INTO FRIENDSLIST VALUES (105,102);
INSERT INTO FRIENDSLIST VALUES (102,103);
INSERT INTO FRIENDSLIST VALUES (103,104);
INSERT INTO FRIENDSLIST VALUES (104,105);
INSERT INTO FRIENDSLIST VALUES (105,101);

/* ------------------------------------------------------------
   QUESTION 4: Create WISHLIST + insert 10 records
   (Uses PRODUCTLIST.PRODUCTCODE values like GAME1..GAME9 and RPG10)
   ------------------------------------------------------------ */

CREATE TABLE WISHLIST (
  USERID      NUMBER(3),
  PRODUCTCODE VARCHAR2(5),
  POSITION    NUMBER(3),
  CONSTRAINT PK_WISHLIST PRIMARY KEY (USERID, PRODUCTCODE),
  CONSTRAINT FK_WISH_USER    FOREIGN KEY (USERID)      REFERENCES USERBASE(USERID),
  CONSTRAINT FK_WISH_PRODUCT FOREIGN KEY (PRODUCTCODE) REFERENCES PRODUCTLIST(PRODUCTCODE)
);

INSERT INTO WISHLIST (USERID, PRODUCTCODE, POSITION) VALUES (101,'GAME1',1);
INSERT INTO WISHLIST (USERID, PRODUCTCODE, POSITION) VALUES (101,'GAME2',2);
INSERT INTO WISHLIST (USERID, PRODUCTCODE, POSITION) VALUES (102,'GAME3',1);
INSERT INTO WISHLIST (USERID, PRODUCTCODE, POSITION) VALUES (103,'GAME4',1);
INSERT INTO WISHLIST (USERID, PRODUCTCODE, POSITION) VALUES (104,'GAME5',1);
INSERT INTO WISHLIST (USERID, PRODUCTCODE, POSITION) VALUES (105,'GAME6',1);
INSERT INTO WISHLIST (USERID, PRODUCTCODE, POSITION) VALUES (102,'GAME7',2);
INSERT INTO WISHLIST (USERID, PRODUCTCODE, POSITION) VALUES (103,'GAME8',2);
INSERT INTO WISHLIST (USERID, PRODUCTCODE, POSITION) VALUES (104,'GAME9',2);
INSERT INTO WISHLIST (USERID, PRODUCTCODE, POSITION) VALUES (105,'RPG10',2);

/* ------------------------------------------------------------
   QUESTION 5: Create USERPROFILE + insert 10 records
   ------------------------------------------------------------ */

CREATE TABLE USERPROFILE (
  USERID      NUMBER(3) PRIMARY KEY,
  IMAGEFILE   VARCHAR2(250),
  DESCRIPTION VARCHAR2(250),
  CONSTRAINT FK_PROFILE_USER FOREIGN KEY (USERID) REFERENCES USERBASE(USERID)
);

INSERT INTO USERPROFILE VALUES (101,'images/user101.jpg','Competitive FPS player.');
INSERT INTO USERPROFILE VALUES (102,'images/user102.jpg','Strategy game fan.');
INSERT INTO USERPROFILE VALUES (103,'images/user103.jpg','Loves RPG adventures.');
INSERT INTO USERPROFILE VALUES (104,'images/user104.jpg','Casual gamer.');
INSERT INTO USERPROFILE VALUES (105,'images/user105.jpg','Speed runner.');
INSERT INTO USERPROFILE VALUES (106,'images/user106.jpg','Indie game supporter.');
INSERT INTO USERPROFILE VALUES (107,'images/user107.jpg','Puzzle solver.');
INSERT INTO USERPROFILE VALUES (108,'images/user108.jpg','Streamer.');
INSERT INTO USERPROFILE VALUES (109,'images/user109.jpg','Collector.');
INSERT INTO USERPROFILE VALUES (110,'images/user110.jpg','Retro gamer.');

/* ------------------------------------------------------------
   QUESTION 6: Create SECURITYQUESTION + insert 10 records
   ------------------------------------------------------------ */

CREATE TABLE SECURITYQUESTION (
  QUESTIONID NUMBER PRIMARY KEY,
  USERID     NUMBER(3),
  QUESTION   VARCHAR2(250),
  ANSWER     VARCHAR2(250),
  CONSTRAINT FK_SECURITY_USER FOREIGN KEY (USERID) REFERENCES USERBASE(USERID)
);

INSERT INTO SECURITYQUESTION VALUES (1,101,'Favorite color?','Blue');
INSERT INTO SECURITYQUESTION VALUES (2,102,'First pet name?','Max');
INSERT INTO SECURITYQUESTION VALUES (3,103,'Birth city?','Atlanta');
INSERT INTO SECURITYQUESTION VALUES (4,104,'Favorite food?','Pizza');
INSERT INTO SECURITYQUESTION VALUES (5,105,'Dream job?','Developer');
INSERT INTO SECURITYQUESTION VALUES (6,106,'Mother maiden name?','Smith');
INSERT INTO SECURITYQUESTION VALUES (7,107,'Favorite movie?','Inception');
INSERT INTO SECURITYQUESTION VALUES (8,108,'High school mascot?','Tiger');
INSERT INTO SECURITYQUESTION VALUES (9,109,'Best friend name?','Chris');
INSERT INTO SECURITYQUESTION VALUES (10,110,'Favorite game?','Zelda');

/* ------------------------------------------------------------
   QUESTION 7: Create COMMUNITYRULES + insert 10 records
   ------------------------------------------------------------ */

CREATE TABLE COMMUNITYRULES (
  RULENUM       NUMBER(3) PRIMARY KEY,
  TITLE         VARCHAR2(250),
  DESCRIPTION   VARCHAR2(250),
  SEVERITYPOINT NUMBER(4)
);

INSERT INTO COMMUNITYRULES VALUES (1,'No Harassment','Respect all users.',50);
INSERT INTO COMMUNITYRULES VALUES (2,'No Cheating','No exploits or hacks.',80);
INSERT INTO COMMUNITYRULES VALUES (3,'No Spam','Avoid repeated content.',30);
INSERT INTO COMMUNITYRULES VALUES (4,'No Hate Speech','Offensive content prohibited.',90);
INSERT INTO COMMUNITYRULES VALUES (5,'No Threats','No threatening behavior.',85);
INSERT INTO COMMUNITYRULES VALUES (6,'No Impersonation','Do not fake identity.',60);
INSERT INTO COMMUNITYRULES VALUES (7,'No Abuse','No abusive language.',70);
INSERT INTO COMMUNITYRULES VALUES (8,'Follow ToS','Adhere to policies.',40);
INSERT INTO COMMUNITYRULES VALUES (9,'Respect Privacy','No doxxing.',95);
INSERT INTO COMMUNITYRULES VALUES (10,'No Advertising','No unauthorized ads.',35);

/* ------------------------------------------------------------
   QUESTION 8: Create INFRACTIONS + insert 10 records
   ------------------------------------------------------------ */

CREATE TABLE INFRACTIONS (
  INFRACTIONID NUMBER PRIMARY KEY,
  USERID       NUMBER(3),
  RULENUM      NUMBER(3),
  DATEASSIGNED DATE,
  PENALTY      VARCHAR2(250),
  CONSTRAINT FK_INF_USER FOREIGN KEY (USERID)  REFERENCES USERBASE(USERID),
  CONSTRAINT FK_INF_RULE FOREIGN KEY (RULENUM) REFERENCES COMMUNITYRULES(RULENUM)
);

INSERT INTO INFRACTIONS VALUES (1,101,2,SYSDATE,'3 day suspension');
INSERT INTO INFRACTIONS VALUES (2,102,1,SYSDATE,'Warning issued');
INSERT INTO INFRACTIONS VALUES (3,103,3,SYSDATE,'Muted 24 hours');
INSERT INTO INFRACTIONS VALUES (4,104,4,SYSDATE,'7 day suspension');
INSERT INTO INFRACTIONS VALUES (5,105,5,SYSDATE,'Permanent ban review');
INSERT INTO INFRACTIONS VALUES (6,106,6,SYSDATE,'Warning');
INSERT INTO INFRACTIONS VALUES (7,107,7,SYSDATE,'Muted');
INSERT INTO INFRACTIONS VALUES (8,108,8,SYSDATE,'Reminder email');
INSERT INTO INFRACTIONS VALUES (9,109,9,SYSDATE,'Account flagged');
INSERT INTO INFRACTIONS VALUES (10,110,10,SYSDATE,'Content removed');

/* ------------------------------------------------------------
   QUESTION 9: Create USERSUPPORT + insert 10 records
   ------------------------------------------------------------ */

CREATE TABLE USERSUPPORT (
  TICKETID      NUMBER PRIMARY KEY,
  EMAIL         VARCHAR2(250),
  ISSUE         VARCHAR2(250),
  DATESUBMITTED DATE,
  DATEUPDATED   DATE,
  STATUS        VARCHAR2(250)
);

INSERT INTO USERSUPPORT VALUES (1,'user1@email.com','Login issue',SYSDATE,SYSDATE,'NEW');
INSERT INTO USERSUPPORT VALUES (2,'user2@email.com','Game crash',SYSDATE,SYSDATE,'IN PROGRESS');
INSERT INTO USERSUPPORT VALUES (3,'user3@email.com','Refund request',SYSDATE,SYSDATE,'CLOSED');
INSERT INTO USERSUPPORT VALUES (4,'user4@email.com','Password reset',SYSDATE,SYSDATE,'NEW');
INSERT INTO USERSUPPORT VALUES (5,'user5@email.com','Lag problem',SYSDATE,SYSDATE,'IN PROGRESS');
INSERT INTO USERSUPPORT VALUES (6,'user6@email.com','Account hacked',SYSDATE,SYSDATE,'NEW');
INSERT INTO USERSUPPORT VALUES (7,'user7@email.com','Update error',SYSDATE,SYSDATE,'CLOSED');
INSERT INTO USERSUPPORT VALUES (8,'user8@email.com','Billing issue',SYSDATE,SYSDATE,'IN PROGRESS');
INSERT INTO USERSUPPORT VALUES (9,'user9@email.com','Profile bug',SYSDATE,SYSDATE,'NEW');
INSERT INTO USERSUPPORT VALUES (10,'user10@email.com','Connection drop',SYSDATE,SYSDATE,'NEW');

/* ------------------------------------------------------------
   QUESTION 10: Create VIEWS (re-runnable)
   ------------------------------------------------------------ */

CREATE OR REPLACE VIEW UNIQUE_SECURITY_QUESTIONS AS
SELECT DISTINCT QUESTION
FROM SECURITYQUESTION;

CREATE OR REPLACE VIEW ACTIVE_TICKETS AS
SELECT TICKETID, EMAIL, ISSUE, DATEUPDATED
FROM USERSUPPORT
WHERE STATUS IN ('NEW','IN PROGRESS')
ORDER BY DATEUPDATED;

COMMIT;
